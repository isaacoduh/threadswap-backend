generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  passwordHash String
  role UserRole @default(USER)

  username String? @unique
  displayName String?
  avatarUrl String?

  // payments (Optional): 
  stripeAccountId String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  listingsSold        Listing[]      @relation("UserListingsSold")
  messagesSent        Message[]      @relation("UserMessagesSent")
  conversationsAsUser1 Conversation[] @relation("ConversationUser1")
  conversationsAsUser2 Conversation[] @relation("ConversationUser2")

  offersMade       Offer[]       @relation("UserOffersMade")
  offersReceived   Offer[]       @relation("UserOffersReceived")

  purchases        Transaction[] @relation("UserPurchases")
  sales            Transaction[] @relation("UserSales")

  reviewsWritten   Review[]      @relation("UserReviewsWritten")
  reviewsReceived  Review[]      @relation("UserReviewsReceived")

  notifications    Notification[]
  savedListings    SavedListing[]

  @@index([email]) 
}

enum Category {
  TOPS
  BOTTOMS
  DRESSES
  OUTERWEAR
  SHOES
  ACCESSORIES
  BAGS
  JEWELRY
  OTHER
}

enum Condition {
  NEW_WITH_TAGS
  NEW_WITHOUT_TAGS
  EXCELLENT
  GOOD
  FAIR
}

enum ListingStatus {
  DRAFT
  ACTIVE
  SOLD
  ARCHIVED
  REMOVED
}

model Listing {
  id String @id @default(uuid()) @db.Uuid
  sellerId String @db.Uuid

  title String
  description String
  brand String
  category String
  condition String
  size String?
  price Decimal @db.Decimal(12, 2)
  currency String @default("GBP")

  status ListingStatus @default(DRAFT)
  images String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // relations
  seller User @relation("UserListingsSold", fields: [sellerId], references: [id], onDelete: Restrict)
  offers      Offer[]
  transaction Transaction?
  savedBy     SavedListing[]

  @@index([sellerId])
  @@index([category])
  @@index([status])
  @@index([price])
  @@index([createdAt])
}


model Conversation {
  id String @id @default(uuid()) @db.Uuid
  user1Id String @db.Uuid
  user2Id String @db.Uuid

  lastMessageAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // relations
  user1         User     @relation("ConversationUser1", fields: [user1Id], references: [id], onDelete: Restrict)
  user2         User     @relation("ConversationUser2", fields: [user2Id], references: [id], onDelete: Restrict)
  messages      Message[]


  @@unique([user1Id, user2Id])
  @@index([user1Id])
  @@index([user2Id])
  @@index([lastMessageAt])
}

model Message {
  id String @id @default(uuid()) @db.Uuid
  conversationId String @db.Uuid
  senderId String @db.Uuid

  text String?
  imageUrl String?
  createdAt DateTime @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender User  @relation("UserMessagesSent", fields: [senderId], references: [id], onDelete: Restrict)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

enum OfferStatus {
  PENDING
  ACCEPTED
  REJECTED
  COUNTERED
  EXPIRED
  WITHDRAWN
}

enum TransactionStatus {
  PENDING
  PAYMENT_PROCESSING
  ESCROW
  SHIPPED
  COMPLETED
  REFUNDED
  DISPUTED
  CANCELLED
}

enum NotificationType {
  NEW_MESSAGE
  OFFER_RECEIVED
  OFFER_ACCEPTED
  OFFER_REJECTED
  PAYMENT_RECEIVED
  ITEM_SHIPPED
  ITEM_DELIVERED
  REVIEW_RECEIVED
  SYSTEM
}

model Offer {
  id        String      @id @default(uuid()) @db.Uuid
  listingId String      @db.Uuid
  buyerId   String      @db.Uuid
  sellerId  String      @db.Uuid

  amount    Decimal     @db.Decimal(12, 2)
  currency  String      @default("GBP")
  status    OfferStatus @default(PENDING)
  note      String?

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // Relations
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  buyer     User    @relation("UserOffersMade", fields: [buyerId], references: [id], onDelete: Restrict)
  seller    User    @relation("UserOffersReceived", fields: [sellerId], references: [id], onDelete: Restrict)

  @@index([listingId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
}

model Transaction {
  id        String            @id @default(uuid()) @db.Uuid
  listingId String            @unique @db.Uuid
  buyerId   String            @db.Uuid
  sellerId  String            @db.Uuid

  status    TransactionStatus @default(PENDING)

  amount    Decimal           @db.Decimal(12, 2)
  currency  String            @default("GBP")

  // Optional payment refs
  stripePaymentIntentId String?
  stripeChargeId        String?

  // Shipping (flexible)
  shippingAddress Json?
  trackingNumber  String?
  shippedAt       DateTime?
  deliveredAt     DateTime?

  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  // Relations
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Restrict)
  buyer     User    @relation("UserPurchases", fields: [buyerId], references: [id], onDelete: Restrict)
  seller    User    @relation("UserSales", fields: [sellerId], references: [id], onDelete: Restrict)
  review    Review?

  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([createdAt])
}


model Review {
  id            String   @id @default(uuid()) @db.Uuid
  transactionId String   @unique @db.Uuid
  reviewerId    String   @db.Uuid
  revieweeId    String   @db.Uuid

  rating        Int
  comment       String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  reviewer    User        @relation("UserReviewsWritten", fields: [reviewerId], references: [id], onDelete: Restrict)
  reviewee    User        @relation("UserReviewsReceived", fields: [revieweeId], references: [id], onDelete: Restrict)

  @@index([reviewerId])
  @@index([revieweeId])
  @@index([rating])
}

model Notification {
  id        String           @id @default(uuid()) @db.Uuid
  userId    String           @db.Uuid

  type      NotificationType
  title     String
  body      String
  data      Json?

  read      Boolean          @default(false)
  readAt    DateTime?

  createdAt DateTime         @default(now())

  // Relations
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model SavedListing {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  listingId String   @db.Uuid

  createdAt DateTime @default(now())

  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
  @@index([userId])
  @@index([listingId])
}
