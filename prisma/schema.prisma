generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  passwordHash String
  role UserRole @default(USER)

  username String? @unique
  displayName String?
  avatarUrl String?

  // payments (Optional): 
  stripeAccountId String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  listingsSold        Listing[]      @relation("UserListingsSold")
  messagesSent        Message[]      @relation("UserMessagesSent")
  conversationsAsUser1 Conversation[] @relation("ConversationUser1")
  conversationsAsUser2 Conversation[] @relation("ConversationUser2")

  @@index([email]) 
}

enum Category {
  TOPS
  BOTTOMS
  DRESSES
  OUTERWEAR
  SHOES
  ACCESSORIES
  BAGS
  JEWELRY
  OTHER
}

enum Condition {
  NEW_WITH_TAGS
  NEW_WITHOUT_TAGS
  EXCELLENT
  GOOD
  FAIR
}

enum ListingStatus {
  DRAFT
  ACTIVE
  SOLD
  ARCHIVED
  REMOVED
}

model Listing {
  id String @id @default(uuid()) @db.Uuid
  sellerId String @db.Uuid

  title String
  description String
  brand String
  category String
  condition String
  size String?
  price Decimal @db.Decimal(12, 2)
  currency String @default("GBP")

  status ListingStatus @default(DRAFT)
  images String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // relations
  seller User @relation("UserListingsSold", fields: [sellerId], references: [id], onDelete: Restrict)

  @@index([sellerId])
  @@index([category])
  @@index([status])
  @@index([price])
  @@index([createdAt])
}


model Conversation {
  id String @id @default(uuid()) @db.Uuid
  user1Id String @db.Uuid
  user2Id String @db.Uuid

  lastMessageAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // relations
  user1         User     @relation("ConversationUser1", fields: [user1Id], references: [id], onDelete: Restrict)
  user2         User     @relation("ConversationUser2", fields: [user2Id], references: [id], onDelete: Restrict)
  messages      Message[]


  @@unique([user1Id, user2Id])
  @@index([user1Id])
  @@index([user2Id])
  @@index([lastMessageAt])
}

model Message {
  id String @id @default(uuid()) @db.Uuid
  conversationId String @db.Uuid
  senderId String @db.Uuid

  text String?
  imageUrl String?
  createdAt DateTime @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender User  @relation("UserMessagesSent", fields: [senderId], references: [id], onDelete: Restrict)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}